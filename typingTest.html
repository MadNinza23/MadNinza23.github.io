<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Speed Test</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
     :root {
    --primary: #4E6851;      /* Green from palette */
    --primary-light: #6a8a6d;
    --secondary: #B83A2D;    /* Red from palette */
    --accent: #DCC9A9;       /* Beige from palette */
    --light: #f8f5f0;        /* Light background */
    --dark: #2c2c2c;         /* Dark text */
    --success: #4E6851;      /* Green for correct */
    --warning: #B83A2D;      /* Red for warnings */
    --danger: #B83A2D;       /* Red for errors */
    --gray: #9c9589;         /* Muted gray */
    --gray-light: #e8e3d9;   /* Light gray */
    --shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    --radius: 16px;
    --transition: all 0.3s ease;
}

.light-theme {
    --primary: #8BCF97;       /* Softer green for dark bg */
    --primary-light: #A7E0B0; /* Lighter tint of green */
    --secondary: #FF6B5E;     /* Vibrant red for accents */
    --accent: #C1A978;        /* Golden-beige accent */
    --light: #1e1e1e;         /* Dark bg */
    --dark: #f5f5f5;          /* Light text */
    --success: #8BCF97;       /* Green for correct */
    --warning: #FF6B5E;       /* Red for warnings */
    --danger: #FF6B5E;        /* Red for errors */
    --gray: #b0aaa0;          /* Muted gray (visible on dark) */
    --gray-light: #3a3a3a;    /* Slightly lighter gray bg */
    --shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
    --radius: 16px;
    --transition: all 0.3s ease;
}

/* Add dark-theme class with the original values */
.dark-theme {
    --primary: #4E6851;      /* Green from palette */
    --primary-light: #6a8a6d;
    --secondary: #B83A2D;    /* Red from palette */
    --accent: #DCC9A9;       /* Beige from palette */
    --light: #f8f5f0;        /* Light background */
    --dark: #2c2c2c;         /* Dark text */
    --success: #4E6851;      /* Green for correct */
    --warning: #B83A2D;      /* Red for warnings */
    --danger: #B83A2D;       /* Red for errors */
    --gray: #9c9589;         /* Muted gray */
    --gray-light: #e8e3d9;   /* Light gray */
    --shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    --radius: 16px;
    --transition: all 0.3s ease;
} 

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
				  --transition: all 0.3s ease;
        }

        /* Top Navbar */
        .top-navbar {
            background-color: var(--light);
            padding: 1rem 1rem;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            border-radius:var(--radius);
            margin : 1rem 1.5rem 1rem 1.5rem;
				
				
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .logo-subtitle {
            font-size: 0.7rem;
            color: var(--gray);
            font-weight: normal;
            margin-left: 0.5rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--dark);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            color: var(--primary);
        }

        /* Main Layout - Split View */
        .main-container {
            display: flex;
            flex: 1;
            height: calc(100vh - 120px);
            gap: 1.5rem;
            padding: 0 1.5rem;
        }

        .test-card, .control-card {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background-color: var(--light);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .test-card:hover, .control-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
        }

        /* Control Center Navbar */
        .control-navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-light);
        }

        .control-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .reset-button {
            background: none;
            border: none;
            color: var(--dark);
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .reset-button:hover {
            color: var(--primary);
        }

        /* Control Center Content */
        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .mode-button {
            background-color: var(--gray-light);
            color: var(--dark);
            border: none;
            padding: 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mode-button:hover {
            background-color: var(--primary);
            color: white;
        }

        .mode-button.active {
            background-color: var(--primary);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: auto;
        }

        .action-button {
            flex: 1;
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .action-button:hover {
            background-color: var(--primary-light);
        }

        .action-button.secondary {
            background-color: var(--gray);
        }

        .action-button.secondary:hover {
            background-color: var(--gray-light);
            color: var(--dark);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--light);
            padding: 2rem;
            border-radius: var(--radius);
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--dark);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .modal-option {
            background-color: var(--gray-light);
            border: none;
            padding: 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
        }

        .modal-option:hover {
            background-color: var(--primary);
            color: white;
        }

        /* Test Card Styles */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background-color: var(--gray-light);
            padding: 1rem;
            border-radius: var(--radius);
            text-align: center;
            transition: var(--transition);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .typing-area {
            position: relative;
            margin: 2rem 0;
        }

        #text-display {
            font-size: 1.2rem;
            line-height: 1.8;
            margin-bottom: 1rem;
            min-height: 150px;
            padding: 1.5rem;
            background-color: var(--gray-light);
            border-radius: var(--radius);
            overflow-wrap: break-word;
            border: 2px solid transparent;
            transition: var(--transition);
            cursor: text;
            user-select: none;
        }

        .word {
            display: inline-block;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .letter {
            display: inline-block;
            transition: var(--transition);
        }

        .correct {
            color: var(--success);
        }

        .incorrect {
            color: var(--danger);
            text-decoration: underline;
        }

        .current {
            background-color: rgba(78, 104, 81, 0.1);
            border-radius: 4px;
        }

        #text-input {
            width: 100%;
            height: 100%;
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            cursor: text;
            font-size: 16px;
        }

        .timer-display {
            font-size: 2rem;
            text-align: center;
            margin: 1rem 0;
            font-weight: bold;
            color: var(--primary);
        }

        .progress-bar {
            height: 8px;
            background-color: var(--gray-light);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }

        .results {
            background-color: var(--light);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            display: none;
            transition: var(--transition);
        }

        .results.active {
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .result-card {
            background-color: var(--gray-light);
            padding: 1rem;
            border-radius: var(--radius);
            text-align: center;
            transition: var(--transition);
        }

        .result-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
        }

        .error-analysis {
            margin-top: 1.5rem;
        }

        .error-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--gray-light);
        }

        .countdown {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 8rem;
            color: white;
            display: none;
        }

        .countdown.active {
            display: flex;
        }

        .history-panel {
            background-color: var(--light);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            display: none;
            max-height: 70vh;
            overflow-y: auto;
            transition: var(--transition);
				 margin : 1rem 1.5rem 1rem 1.5rem ;
        }

        .history-panel.active {
            display: block;
        }

        .history-item {
            background-color: var(--gray-light);
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .history-stat {
            text-align: center;
            padding: 0.5rem;
            background-color: var(--light);
            border-radius: var(--radius);
        }

        .history-value {
            font-weight: bold;
            color: var(--primary);
        }

        footer {
            text-align: center;
            padding: 1rem;
            background-color: var(--light);
            margin-top: auto;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem;
				 opacity : 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
                gap: 1rem;
            }
            
            .test-card, .control-card {
                padding: 1rem;
                width: 100%;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            #text-display {
                font-size: 1rem;
            }
            
            .countdown {
                font-size: 5rem;
            }
            
            /* Control center goes above test card on small screens */
            .main-container {
                flex-direction: column-reverse;
            }
        }

        @media (max-width: 480px) {
            .stats, .results-grid {
                grid-template-columns: 1fr;
            }
            
            .countdown {
                font-size: 4rem;
            }
            
            .history-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .top-navbar {
                padding: 1rem;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .logo-subtitle {
                font-size: 0.6rem;
            }
        }
    </style>
</head>
<body class="dark-theme">
    <!-- Top Navbar -->
    <nav class="top-navbar">
        <div class="logo">
            <i class="fas fa-keyboard"></i>
            <span>Typing Test <span class="logo-subtitle">by h1m</span></span>
        </div>
        <button class="theme-toggle" id="theme-toggle">
            <i class="fas fa-moon"></i>
        </button>
    </nav>

    <!-- Main Content - Split View -->
    <div class="main-container">
        <!-- Left Side - Test Card -->
        <div class="test-card">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">WPM</div>
                    <div class="stat-value" id="wpm">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">CPM</div>
                    <div class="stat-value" id="cpm">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Accuracy</div>
                    <div class="stat-value" id="accuracy">100%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Errors</div>
                    <div class="stat-value" id="errors">0</div>
                </div>
            </div>

            <div class="typing-area">
                <div id="text-display" tabindex="0">Press "Start Test" to begin typing</div>
                <input type="text" id="text-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                <div class="progress-bar">
                    <div class="progress" id="progress-bar"></div>
                </div>
                <div class="timer-display" id="timer">00:30</div>
            </div>

            <div class="results" id="results">
                <h2>Test Results</h2>
                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-label">WPM</div>
                        <div class="result-value" id="result-wpm">0</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">CPM</div>
                        <div class="result-value" id="result-cpm">0</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Accuracy</div>
                        <div class="result-value" id="result-accuracy">100%</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Time</div>
                        <div class="result-value" id="result-time">0s</div>
                    </div>
                </div>
                <div class="error-analysis">
                    <h3>Error Analysis</h3>
                    <div id="error-list"></div>
                </div>
                <div style="text-align: center; margin-top: 1.5rem;">
                    <button id="share-results" class="action-button">Share Results</button>
                </div>
            </div>
        </div>

        <!-- Right Side - Control Center Card -->
        <div class="control-card">
            <div class="control-navbar">
                <div class="control-title">Control Center</div>
                <button class="reset-button" id="reset-button">
                    <i class="fas fa-redo"></i>
                </button>
            </div>

            <div class="mode-buttons">
                <button class="mode-button" id="time-trial-button">
                    Time Trial
                    <span id="time-trial-value">30s</span>
                </button>
                <button class="mode-button" id="word-count-button">
                    Word Count
                    <span id="word-count-value">50</span>
                </button>
                <button class="mode-button" id="coding-mode-button">
                    Coding Mode
                    <span id="coding-mode-value">JavaScript</span>
                </button>
            </div>

            <div class="action-buttons">
                <button class="action-button secondary" id="history-button">View Result History</button>
                <button class="action-button" id="start-test">Start Test</button>
            </div>
        </div>
    </div>

    <!-- Modals for Mode Selection -->
    <div class="modal" id="time-trial-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Time Duration</h3>
                <button class="modal-close" id="close-time-trial">&times;</button>
            </div>
            <div class="modal-options">
                <button class="modal-option" data-value="30">30 seconds</button>
                <button class="modal-option" data-value="60">60 seconds</button>
                <button class="modal-option" data-value="120">120 seconds</button>
            </div>
        </div>
    </div>

    <div class="modal" id="word-count-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Word Count</h3>
                <button class="modal-close" id="close-word-count">&times;</button>
            </div>
            <div class="modal-options">
                <button class="modal-option" data-value="25">25 words</button>
                <button class="modal-option" data-value="50">50 words</button>
                <button class="modal-option" data-value="100">100 words</button>
            </div>
        </div>
    </div>

    <div class="modal" id="coding-mode-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Programming Language</h3>
                <button class="modal-close" id="close-coding-mode">&times;</button>
            </div>
            <div class="modal-options">
                <button class="modal-option" data-value="javascript">JavaScript</button>
                <button class="modal-option" data-value="python">Python</button>
                <button class="modal-option" data-value="java">Java</button>
                <button class="modal-option" data-value="cpp">C++</button>
                <button class="modal-option" data-value="html">HTML</button>
            </div>
        </div>
    </div>

    <!-- History Panel -->
    <div class="history-panel" id="history-panel">
        <h2>Results History</h2>
        <div id="history-list">
            <!-- History items will be inserted here -->
        </div>
        <div style="text-align: center; margin-top: 1.5rem;">
            <button id="clear-history" class="action-button secondary">Clear History</button>
            <button id="close-history" class="action-button">Close</button>
        </div>
    </div>

    <!-- Countdown -->
    <div class="countdown" id="countdown">3</div>

    <footer>
        <p>Improve your typing speed and accuracy</p>
    </footer>

    
<script>
    // Sample text data (unchanged)
    const textData = {
        common: [
            "The quick brown fox jumps over the lazy dog. This sentence contains all the letters in the English alphabet.",
            "Typing is an essential skill in today's digital world. Practice regularly to improve your speed and accuracy.",
            "Programming requires precise typing skills. Developers often need to type complex code quickly and accurately.",
            "Communication through writing has become more important than ever. Good typing skills help you express ideas faster.",
            "Learning to touch type can significantly increase your productivity. It allows you to focus on content rather than keys."
        ],
        quotes: [
            "The only way to do great work is to love what you do. - Steve Jobs",
            "Innovation distinguishes between a leader and a follower. - Steve Jobs",
            "Your time is limited, so don't waste it living someone else's life. - Steve Jobs",
            "The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt",
            "Success is not final, failure is not fatal: it is the courage to continue that counts. - Winston Churchill"
        ],
        pangrams: [
            "The quick brown fox jumps over the lazy dog.",
            "Pack my box with five dozen liquor jugs.",
            "How vexingly quick daft zebras jump!",
            "Waltz, bad nymph, for quick jigs vex.",
            "Sphinx of black quartz, judge my vow."
        ],
        javascript: [
            "function calculateSum(a, b) { return a + b; }",
            "const numbers = [1, 2, 3, 4, 5]; const doubled = numbers.map(n => n * 2);",
            "class Person { constructor(name) { this.name = name; } greet() { return `Hello, ${this.name}`; } }",
            "const fetchData = async () => { const response = await fetch('/api/data'); return response.json(); }",
            "if (user && user.isActive) { console.log('User is active'); } else { console.log('User is inactive'); }"
        ],
        python: [
            "def calculate_sum(a, b): return a + b",
            "numbers = [1, 2, 3, 4, 5] doubled = [n * 2 for n in numbers]",
            "class Person: def __init__(self, name): self.name = name def greet(self): return f'Hello, {self.name}'",
            "with open('file.txt', 'r') as file: content = file.read()",
            "if user and user.is_active: print('User is active') else: print('User is inactive')"
        ],
        java: [
            "public int calculateSum(int a, int b) { return a + b; }",
            "List<Integer> numbers = Arrays.asList(1, 2, 3, 4, 5); List<Integer> doubled = numbers.stream().map(n -> n * 2).collect(Collectors.toList());",
            "public class Person { private String name; public Person(String name) { this.name = name; } public String greet() { return \"Hello, \" + name; } }",
            "try { File file = new File(\"file.txt\"); Scanner scanner = new Scanner(file); while (scanner.hasNextLine()) { String line = scanner.nextLine(); } } catch (FileNotFoundException e) { e.printStackTrace(); }",
            "if (user != null && user.isActive()) { System.out.println(\"User is active\"); } else { System.out.println(\"User is inactive\"); }"
        ],
        cpp: [
            "int calculateSum(int a, int b) { return a + b; }",
            "vector<int> numbers = {1, 2, 3, 4, 5}; vector<int> doubled; for (int n : numbers) { doubled.push_back(n * 2); }",
            "class Person { private: string name; public: Person(string name) : name(name) {} string greet() { return \"Hello, \" + name; } };",
            "ifstream file(\"file.txt\"); string line; while (getline(file, line)) { cout << line << endl; }",
            "if (user != nullptr && user->isActive()) { cout << \"User is active\" << endl; } else { cout << \"User is inactive\" << endl; }"
        ],
        html: [
            "<div class=\"container\"><h1>Welcome</h1><p>This is a paragraph</p></div>",
            "<form action=\"/submit\" method=\"post\"><input type=\"text\" name=\"username\" placeholder=\"Enter username\"><button type=\"submit\">Submit</button></form>",
            "<table><tr><th>Name</th><th>Age</th></tr><tr><td>John</td><td>25</td></tr><tr><td>Jane</td><td>30</td></tr></table>",
            "<nav><ul><li><a href=\"#home\">Home</a></li><li><a href=\"#about\">About</a></li><li><a href=\"#contact\">Contact</a></li></ul></nav>",
            "<!DOCTYPE html><html><head><title>My Page</title></head><body><h1>Hello World</h1></body></html>"
        ]
    };

    // DOM Elements (unchanged)
    const textDisplay = document.getElementById('text-display');
    const textInput = document.getElementById('text-input');
    const wpmElement = document.getElementById('wpm');
    const cpmElement = document.getElementById('cpm');
    const accuracyElement = document.getElementById('accuracy');
    const errorsElement = document.getElementById('errors');
    const timerElement = document.getElementById('timer');
    const progressBar = document.getElementById('progress-bar');
    const resultsElement = document.getElementById('results');
    const resultWpmElement = document.getElementById('result-wpm');
    const resultCpmElement = document.getElementById('result-cpm');
    const resultAccuracyElement = document.getElementById('result-accuracy');
    const resultTimeElement = document.getElementById('result-time');
    const errorListElement = document.getElementById('error-list');
    const countdownElement = document.getElementById('countdown');
    const themeToggle = document.getElementById('theme-toggle');
    const startTestButton = document.getElementById('start-test');
    const shareResultsButton = document.getElementById('share-results');
    const timeTrialButton = document.getElementById('time-trial-button');
    const wordCountButton = document.getElementById('word-count-button');
    const codingModeButton = document.getElementById('coding-mode-button');
    const timeTrialValue = document.getElementById('time-trial-value');
    const wordCountValue = document.getElementById('word-count-value');
    const codingModeValue = document.getElementById('coding-mode-value');
    const historyButton = document.getElementById('history-button');
    const historyPanel = document.getElementById('history-panel');
    const historyList = document.getElementById('history-list');
    const clearHistoryButton = document.getElementById('clear-history');
    const closeHistoryButton = document.getElementById('close-history');
    const resetButton = document.getElementById('reset-button');
    
    // Modal Elements (unchanged)
    const timeTrialModal = document.getElementById('time-trial-modal');
    const wordCountModal = document.getElementById('word-count-modal');
    const codingModeModal = document.getElementById('coding-mode-modal');
    const closeTimeTrial = document.getElementById('close-time-trial');
    const closeWordCount = document.getElementById('close-word-count');
    const closeCodingMode = document.getElementById('close-coding-mode');
    const timeTrialOptions = timeTrialModal.querySelectorAll('.modal-option');
    const wordCountOptions = wordCountModal.querySelectorAll('.modal-option');
    const codingModeOptions = codingModeModal.querySelectorAll('.modal-option');

    // App State - UPDATED with new properties
    let state = {
        currentText: '',
        words: [],
        currentWordIndex: 0,
        currentLetterIndex: 0,
        startTime: null,
        endTime: null,
        timerInterval: null,
        timeLeft: 30,
        totalTime: 30,
        totalChars: 0,
        correctChars: 0,
        errors: 0,
        errorMap: new Map(),
        isRunning: false,
        isFinished: false,
        mode: 'time', // 'time', 'words', 'coding'
        wordGoal: 50,
        codingLanguage: 'javascript',
        testHistory: [],
        hasStartedFirstTest: false,
        // NEW: Track typed characters for backspace support
        typedCharacters: [],
        // NEW: Track word completion for word mode
        completedWords: 0
    };

    // Initialize the app
    function init() {
        setupEventListeners();
        loadHistoryFromStorage();
        resetToDefaults();
        
        // Set initial text display message
        textDisplay.textContent = "Press 'Start Test' to begin typing";
    }

    // Reset everything to default values
    function resetToDefaults() {
        state.mode = 'time';
        state.timeLeft = 30;
        state.totalTime = 30;
        state.wordGoal = 50;
        state.codingLanguage = 'javascript';
        
        // Update UI to reflect defaults
        timeTrialValue.textContent = '30s';
        wordCountValue.textContent = '50';
        codingModeValue.textContent = 'JavaScript';
        
        // Reset active states
        timeTrialButton.classList.add('active');
        wordCountButton.classList.remove('active');
        codingModeButton.classList.remove('active');
        
        // Reset test state
        resetStats();
    }

    // Load new text based on selected mode
    function loadNewText() {
        let category = 'common';
        
        if (state.mode === 'coding') {
            category = state.codingLanguage;
        } else {
            // Randomly select between common, quotes, and pangrams
            const categories = ['common', 'quotes', 'pangrams'];
            category = categories[Math.floor(Math.random() * categories.length)];
        }
        
        const texts = textData[category];
        const randomIndex = Math.floor(Math.random() * texts.length);
        state.currentText = texts[randomIndex];
        state.words = state.currentText.split(' ').map(word => {
            return {
                text: word,
                letters: word.split('').map(letter => {
                    return {
                        char: letter,
                        status: 'pending'
                    };
                })
            };
        });
        
        // NEW: Reset word completion tracking
        state.completedWords = 0;
        
        renderText();
        resetStats();
    }

    // Render the text to be typed - IMPROVED with better visual feedback
    function renderText() {
        if (state.currentText && state.words.length > 0) {
            textDisplay.innerHTML = '';
            
            state.words.forEach((word, wordIndex) => {
                const wordElement = document.createElement('span');
                wordElement.className = 'word';
                
                // Highlight current word with a more prominent style
                if (wordIndex === state.currentWordIndex) {
                    wordElement.classList.add('current');
                    wordElement.style.backgroundColor = 'rgba(78, 104, 81, 0.2)';
                    wordElement.style.padding = '2px 4px';
                    wordElement.style.borderRadius = '4px';
                }
                
                word.letters.forEach((letter, letterIndex) => {
                    const letterElement = document.createElement('span');
                    letterElement.className = 'letter';
                    letterElement.textContent = letter.char;
                    
                    if (letter.status === 'correct') {
                        letterElement.classList.add('correct');
                        letterElement.style.fontWeight = 'bold';
                    } else if (letter.status === 'incorrect') {
                        letterElement.classList.add('incorrect');
                        letterElement.style.textDecoration = 'underline wavy';
                    }
                    
                    // Highlight current letter within current word
                    if (wordIndex === state.currentWordIndex && letterIndex === state.currentLetterIndex) {
                        letterElement.style.backgroundColor = 'rgba(78, 104, 81, 0.4)';
                        letterElement.style.borderRadius = '2px';
                    }
                    
                    wordElement.appendChild(letterElement);
                });
                
                if (wordIndex < state.words.length - 1) {
                    const spaceElement = document.createElement('span');
                    spaceElement.className = 'letter';
                    spaceElement.textContent = ' ';
                    
                    // Highlight space if it's the current position
                    if (wordIndex === state.currentWordIndex && state.currentLetterIndex >= word.letters.length) {
                        spaceElement.style.backgroundColor = 'rgba(78, 104, 81, 0.4)';
                        spaceElement.style.borderRadius = '2px';
                    }
                    
                    wordElement.appendChild(spaceElement);
                }
                
                textDisplay.appendChild(wordElement);
            });
        }
    }

    // Reset statistics - UPDATED with new properties
    function resetStats() {
        state.currentWordIndex = 0;
        state.currentLetterIndex = 0;
        state.startTime = null;
        state.endTime = null;
        state.timeLeft = getInitialTime();
        state.totalTime = getInitialTime();
        state.totalChars = 0;
        state.correctChars = 0;
        state.errors = 0;
        state.errorMap.clear();
        state.isRunning = false;
        state.isFinished = false;
        state.typedCharacters = [];
        state.completedWords = 0;
        
        if (state.timerInterval) {
            clearInterval(state.timerInterval);
            state.timerInterval = null;
        }
        
        wpmElement.textContent = '0';
        cpmElement.textContent = '0';
        accuracyElement.textContent = '100%';
        errorsElement.textContent = '0';
        timerElement.textContent = formatTime(state.timeLeft);
        progressBar.style.width = '0%';
        resultsElement.classList.remove('active');
        
        if (state.words.length > 0) {
            state.words.forEach(word => {
                word.letters.forEach(letter => {
                    letter.status = 'pending';
                });
            });
        }
        
        renderText();
    }

    // Get initial time based on selected mode
    function getInitialTime() {
        if (state.mode === 'words' || state.mode === 'coding') return 999;
        return state.timeLeft;
    }

    // Format time as MM:SS
    function formatTime(seconds) {
        if (seconds === 999) return "∞";
        
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Start the typing test
    function startTest() {
        if (state.isRunning) return;
        
        if (!state.currentText || state.words.length === 0) {
            loadNewText();
        }
        
        state.isRunning = true;
        
        // Update button text after first start
        if (!state.hasStartedFirstTest) {
            state.hasStartedFirstTest = true;
            startTestButton.textContent = "Retake Test";
        }
        
        startCountdown();
    }

    // Start the 3-2-1 countdown
    function startCountdown() {
        let count = 3;
        countdownElement.textContent = count;
        countdownElement.classList.add('active');
        
        textInput.focus();
        
        const countdownInterval = setInterval(() => {
            count--;
            countdownElement.textContent = count;
            
            if (count <= 0) {
                clearInterval(countdownInterval);
                countdownElement.classList.remove('active');
                
                state.startTime = new Date();
                startTimer();
                
                setTimeout(() => {
                    textInput.focus();
                }, 100);
            }
        }, 1000);
    }

    // Start the test timer
    function startTimer() {
        state.timerInterval = setInterval(() => {
            if (state.mode === 'time') {
                state.timeLeft--;
                timerElement.textContent = formatTime(state.timeLeft);
                
                const progress = ((state.totalTime - state.timeLeft) / state.totalTime) * 100;
                progressBar.style.width = `${progress}%`;
                
                if (state.timeLeft <= 0) {
                    finishTest();
                }
            }
            
            // Update stats continuously during the test
            updateStats();
        }, 1000);
    }

    // Handle typing input - COMPLETELY REWRITTEN with backspace support
    function handleInput(e) {
        if (!state.isRunning || state.isFinished) return;
        
        const input = e.data;
        const isBackspace = e.inputType === 'deleteContentBackward';
        
        // Clear the input field but keep track of what was typed
        setTimeout(() => {
            textInput.value = '';
        }, 0);
        
        if (isBackspace) {
            handleBackspace();
            return;
        }
        
        if (!input) return; // Ignore if no input (e.g., control keys)
        
        const currentWord = state.words[state.currentWordIndex];
        if (!currentWord) return;
        
        // Track the typed character
        state.typedCharacters.push({
            wordIndex: state.currentWordIndex,
            letterIndex: state.currentLetterIndex,
            char: input,
            timestamp: Date.now()
        });
        
        if (input === ' ') {
            handleSpace();
        } else {
            handleCharacter(input);
        }
        
        renderText();
        updateStats();
        
        // Check if word goal is reached (for word mode)
        if (state.mode === 'words' && state.completedWords >= state.wordGoal) {
            finishTest();
        }
    }

    // Handle backspace key - NEW FUNCTION
    function handleBackspace() {
        if (state.typedCharacters.length === 0) return;
        
        // Remove the last typed character
        const lastChar = state.typedCharacters.pop();
        
        // If we're at the beginning of a word and there are previous characters, go back
        if (state.currentLetterIndex === 0 && state.currentWordIndex > 0) {
            // Move to previous word
            state.currentWordIndex--;
            const prevWord = state.words[state.currentWordIndex];
            state.currentLetterIndex = prevWord.letters.length;
            
            // Decrement completed words if we're going back past a word boundary
            if (state.currentLetterIndex === prevWord.letters.length) {
                state.completedWords = Math.max(0, state.completedWords - 1);
            }
        } else if (state.currentLetterIndex > 0) {
            // Move back within current word
            state.currentLetterIndex--;
            
            const currentWord = state.words[state.currentWordIndex];
            const letter = currentWord.letters[state.currentLetterIndex];
            
            // Reset the letter status
            if (letter.status === 'incorrect') {
                state.errors = Math.max(0, state.errors - 1);
            } else if (letter.status === 'correct') {
                state.correctChars = Math.max(0, state.correctChars - 1);
                state.totalChars = Math.max(0, state.totalChars - 1);
            }
            
            letter.status = 'pending';
        }
        
        renderText();
        updateStats();
    }

    // Handle space bar - UPDATED to not penalize untyped characters
    function handleSpace() {
        const currentWord = state.words[state.currentWordIndex];
        
        // Only mark typed characters as incorrect, not untyped ones
        for (let i = 0; i < Math.min(state.currentLetterIndex, currentWord.letters.length); i++) {
            if (currentWord.letters[i].status === 'pending') {
                currentWord.letters[i].status = 'incorrect';
                state.errors++;
                
                // Track error frequency
                const errorChar = currentWord.letters[i].char;
                state.errorMap.set(errorChar, (state.errorMap.get(errorChar) || 0) + 1);
            }
        }
        
        // Move to next word
        state.currentWordIndex++;
        state.currentLetterIndex = 0;
        state.completedWords++;
        
        // Check if we need to load more text
        if (state.currentWordIndex >= state.words.length) {
            if (state.mode === 'words' && state.completedWords < state.wordGoal) {
                loadNewText();
            } else {
                finishTest();
            }
        }
    }

    // Handle character input - UPDATED
    function handleCharacter(input) {
        const currentWord = state.words[state.currentWordIndex];
        if (!currentWord || state.currentLetterIndex >= currentWord.letters.length) return;
        
        const currentLetter = currentWord.letters[state.currentLetterIndex];
        
        if (input === currentLetter.char) {
            currentLetter.status = 'correct';
            state.correctChars++;
        } else {
            currentLetter.status = 'incorrect';
            state.errors++;
            
            // Track error frequency
            const errorChar = currentLetter.char;
            state.errorMap.set(errorChar, (state.errorMap.get(errorChar) || 0) + 1);
        }
        
        state.currentLetterIndex++;
        state.totalChars++;
        
        // Auto-advance to next word if at the end of current word
        if (state.currentLetterIndex >= currentWord.letters.length) {
            // In word mode, check if we've reached the goal
            if (state.mode === 'words' && state.completedWords >= state.wordGoal - 1) {
                finishTest();
            }
        }
    }

    // Update real-time statistics - UPDATED with word counting
    function updateStats() {
        if (!state.startTime) return;
        
        const currentTime = new Date();
        const elapsedSeconds = (currentTime - state.startTime) / 1000;
        const minutes = elapsedSeconds / 60;
        
        // Calculate WPM and CPM
        const wpm = Math.round(state.correctChars / 5 / minutes) || 0;
        const cpm = Math.round(state.correctChars / minutes) || 0;
        const accuracy = state.totalChars > 0 ? Math.round((state.correctChars / state.totalChars) * 100) : 100;
        
        wpmElement.textContent = wpm;
        cpmElement.textContent = cpm;
        accuracyElement.textContent = `${accuracy}%`;
        errorsElement.textContent = state.errors;
        
        // Update progress bar for word mode
        if (state.mode === 'words') {
            const progress = (state.completedWords / state.wordGoal) * 100;
            progressBar.style.width = `${Math.min(progress, 100)}%`;
        }
    }

    // Finish the test and show results - UPDATED with word count tracking
    function finishTest() {
        state.isRunning = false;
        state.isFinished = true;
        state.endTime = new Date();
        
        if (state.timerInterval) {
            clearInterval(state.timerInterval);
            state.timerInterval = null;
        }
        
        const elapsedSeconds = (state.endTime - state.startTime) / 1000;
        const minutes = elapsedSeconds / 60;
        
        // Calculate final statistics
        const wpm = Math.round(state.correctChars / 5 / minutes) || 0;
        const cpm = Math.round(state.correctChars / minutes) || 0;
        const accuracy = state.totalChars > 0 ? Math.round((state.correctChars / state.totalChars) * 100) : 100;
        
        // Update result display
        resultWpmElement.textContent = wpm;
        resultCpmElement.textContent = cpm;
        resultAccuracyElement.textContent = `${accuracy}%`;
        resultTimeElement.textContent = `${Math.round(elapsedSeconds)}s`;
        
        // Show error analysis
        errorListElement.innerHTML = '';
        if (state.errorMap.size > 0) {
            const sortedErrors = Array.from(state.errorMap.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            sortedErrors.forEach(([char, count]) => {
                const errorItem = document.createElement('div');
                errorItem.className = 'error-item';
                errorItem.innerHTML = `
                    <span>${char === ' ' ? 'Space' : char}</span>
                    <span>${count} error${count !== 1 ? 's' : ''}</span>
                `;
                errorListElement.appendChild(errorItem);
            });
        } else {
            const noErrors = document.createElement('div');
            noErrors.className = 'error-item';
            noErrors.textContent = 'No errors made! Excellent typing!';
            errorListElement.appendChild(noErrors);
        }
        
        // Show results
        resultsElement.classList.add('active');
        
        // Save to history
        saveToHistory(wpm, cpm, accuracy, Math.round(elapsedSeconds));
        
        // Scroll to results
        resultsElement.scrollIntoView({ behavior: 'smooth' });
    }

    // Save test results to history
    function saveToHistory(wpm, cpm, accuracy, time) {
        const result = {
            wpm,
            cpm,
            accuracy,
            time,
            mode: state.mode,
            date: new Date().toISOString()
        };
        
        state.testHistory.unshift(result);
        
        // Keep only last 10 results
        if (state.testHistory.length > 10) {
            state.testHistory = state.testHistory.slice(0, 10);
        }
        
        saveHistoryToStorage();
        updateHistoryDisplay();
    }

    // Update the history display
    function updateHistoryDisplay() {
        historyList.innerHTML = '';
        
        if (state.testHistory.length === 0) {
            historyList.innerHTML = '<p>No test results yet. Complete a test to see your history.</p>';
            return;
        }
        
        state.testHistory.forEach((result, index) => {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            const date = new Date(result.date);
            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            historyItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>Test #${state.testHistory.length - index}</strong>
                    <span>${formattedDate}</span>
                </div>
                <div class="history-stats">
                    <div class="history-stat">
                        <div>WPM</div>
                        <div class="history-value">${result.wpm}</div>
                    </div>
                    <div class="history-stat">
                        <div>CPM</div>
                        <div class="history-value">${result.cpm}</div>
                    </div>
                    <div class="history-stat">
                        <div>Accuracy</div>
                        <div class="history-value">${result.accuracy}%</div>
                    </div>
                    <div class="history-stat">
                        <div>Time</div>
                        <div class="history-value">${result.time}s</div>
                    </div>
                </div>
            `;
            
            historyList.appendChild(historyItem);
        });
    }

    // Save history to localStorage
    function saveHistoryToStorage() {
        localStorage.setItem('typingTestHistory', JSON.stringify(state.testHistory));
    }

    // Load history from localStorage
    function loadHistoryFromStorage() {
        const savedHistory = localStorage.getItem('typingTestHistory');
        if (savedHistory) {
            state.testHistory = JSON.parse(savedHistory);
            updateHistoryDisplay();
        }
    }

    // Clear history
    function clearHistory() {
        state.testHistory = [];
        saveHistoryToStorage();
        updateHistoryDisplay();
    }

    // Share results
    function shareResults() {
        const resultWpm = resultWpmElement.textContent;
        const resultAccuracy = resultAccuracyElement.textContent;
        
        const shareText = `I just scored ${resultWpm} WPM with ${resultAccuracy} accuracy on this typing test! Try it yourself.`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Typing Test Results',
                text: shareText,
                url: window.location.href
            });
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(shareText).then(() => {
                alert('Results copied to clipboard!');
            });
        }
    }

    // Toggle theme
    function toggleTheme() {
        const body = document.body;
        const isLight = body.classList.contains('light-theme');
        
        if (isLight) {
            body.classList.remove('light-theme');
            body.classList.add('dark-theme');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            body.classList.remove('dark-theme');
            body.classList.add('light-theme');
            themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        }
    }

    // Set up event listeners - UPDATED to allow backspace
    function setupEventListeners() {
        // Theme toggle
        themeToggle.addEventListener('click', toggleTheme);
        
        // Start test button
        startTestButton.addEventListener('click', startTest);
        
        // Share results button
        shareResultsButton.addEventListener('click', shareResults);
        
        // Mode selection buttons
        timeTrialButton.addEventListener('click', () => {
            timeTrialModal.classList.add('active');
        });
        
        wordCountButton.addEventListener('click', () => {
            wordCountModal.classList.add('active');
        });
        
        codingModeButton.addEventListener('click', () => {
            codingModeModal.classList.add('active');
        });
        
        // Modal close buttons
        closeTimeTrial.addEventListener('click', () => {
            timeTrialModal.classList.remove('active');
        });
        
        closeWordCount.addEventListener('click', () => {
            wordCountModal.classList.remove('active');
        });
        
        closeCodingMode.addEventListener('click', () => {
            codingModeModal.classList.remove('active');
        });
        
        // Time trial options
        timeTrialOptions.forEach(option => {
            option.addEventListener('click', () => {
                const value = parseInt(option.getAttribute('data-value'));
                state.timeLeft = value;
                state.totalTime = value;
                timeTrialValue.textContent = `${value}s`;
                timeTrialModal.classList.remove('active');
                
                // Set mode to time trial
                state.mode = 'time';
                timeTrialButton.classList.add('active');
                wordCountButton.classList.remove('active');
                codingModeButton.classList.remove('active');
                
                resetStats();
            });
        });
        
        // Word count options
        wordCountOptions.forEach(option => {
            option.addEventListener('click', () => {
                const value = parseInt(option.getAttribute('data-value'));
                state.wordGoal = value;
                wordCountValue.textContent = value;
                wordCountModal.classList.remove('active');
                
                // Set mode to word count
                state.mode = 'words';
                timeTrialButton.classList.remove('active');
                wordCountButton.classList.add('active');
                codingModeButton.classList.remove('active');
                
                resetStats();
            });
        });
        
        // Coding mode options
        codingModeOptions.forEach(option => {
            option.addEventListener('click', () => {
                const value = option.getAttribute('data-value');
                const displayName = option.textContent;
                state.codingLanguage = value;
                codingModeValue.textContent = displayName;
                codingModeModal.classList.remove('active');
                
                // Set mode to coding
                state.mode = 'coding';
                timeTrialButton.classList.remove('active');
                wordCountButton.classList.remove('active');
                codingModeButton.classList.add('active');
                
                resetStats();
            });
        });
        
        // History button
        historyButton.addEventListener('click', () => {
            historyPanel.classList.add('active');
        });
        
        // Clear history button
        clearHistoryButton.addEventListener('click', clearHistory);
        
        // Close history button
        closeHistoryButton.addEventListener('click', () => {
            historyPanel.classList.remove('active');
        });
        
        // Reset button
        resetButton.addEventListener('click', resetStats);
        
        // Text input handling - UPDATED to allow backspace
        textInput.addEventListener('input', handleInput);
        
        // Allow backspace and navigation keys (removed preventDefault)
        textInput.addEventListener('keydown', (e) => {
            // Allow these keys to function normally
            if (['Backspace', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Tab'].includes(e.key)) {
                // Let the browser handle these keys normally
                return;
            }
            
            // Prevent default for other keys to avoid cursor movement
            if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                e.preventDefault();
            }
        });
        
        // Click on text display to focus input
        textDisplay.addEventListener('click', () => {
            textInput.focus();
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === timeTrialModal) {
                timeTrialModal.classList.remove('active');
            }
            if (e.target === wordCountModal) {
                wordCountModal.classList.remove('active');
            }
            if (e.target === codingModeModal) {
                codingModeModal.classList.remove('active');
            }
            if (e.target === historyPanel) {
                historyPanel.classList.remove('active');
            }
        });
    }

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>